/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.ouc.cpss.view;

import com.ouc.cpss.biz.CustomerBiz;
import com.ouc.cpss.biz.CustomerBizImpl;
import com.ouc.cpss.biz.EmployeeBiz;
import com.ouc.cpss.biz.EmployeeBizImpl;
import com.ouc.cpss.biz.ProductBiz;
import com.ouc.cpss.biz.ProductBizImpl;
import com.ouc.cpss.biz.SellsBiz;
import com.ouc.cpss.biz.SellsBizImpl;
import com.ouc.cpss.po.Customer;
import com.ouc.cpss.po.Employee;
import com.ouc.cpss.po.Product;
import com.ouc.cpss.vo.ViewPurchase;
import com.ouc.cpss.vo.ViewSell;
import java.math.BigDecimal;
import java.sql.Date;
import java.util.List;
import java.util.Vector;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;

/**
 *
 * @author su
 */
public class SelReturnFrame extends javax.swing.JInternalFrame {
    SellsBiz sbiz = new SellsBizImpl();
    CustomerBiz cusbiz = new CustomerBizImpl();
    ProductBiz pbiz = new ProductBizImpl();
    int selectrow = -1;// 确保退货时选中了采购单
    /**
     * Creates new form SelReturnFrame
     */
    public SelReturnFrame() {
        initComponents();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jLabel1 = new javax.swing.JLabel();
        txtCondition = new javax.swing.JTextField();
        btnQuery = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        tblSell = new javax.swing.JTable();
        jPanel1 = new javax.swing.JPanel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        txtSelid = new javax.swing.JTextField();
        txtProname = new javax.swing.JTextField();
        txtSelcount = new javax.swing.JTextField();
        jLabel5 = new javax.swing.JLabel();
        txtReturnAmount = new javax.swing.JTextField();
        btnSrt = new javax.swing.JButton();
        btnCancel = new javax.swing.JButton();
        dateEnd = new com.ouc.cpss.util.DateChooserJButton();
        dateStart = new com.ouc.cpss.util.DateChooserJButton();

        setClosable(true);
        setIconifiable(true);
        setMaximizable(true);
        setResizable(true);
        setTitle("销售退货");

        jLabel1.setText("--");

        btnQuery.setText("查询");
        btnQuery.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnQueryActionPerformed(evt);
            }
        });

        tblSell.setModel(new javax.swing.table.DefaultTableModel(
            new Object [][] {

            },
            new String [] {
                "销售编号", "商品名称", "商品型号", "买家姓名", "销售数量", "销售单价", "销售日期"
            }
        ) {
            boolean[] canEdit = new boolean [] {
                false, true, true, true, true, true, true
            };

            public boolean isCellEditable(int rowIndex, int columnIndex) {
                return canEdit [columnIndex];
            }
        });
        tblSell.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                tblSellMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(tblSell);

        jLabel2.setText("销售编号");

        jLabel3.setText("商品名称");

        jLabel4.setText("销售数量");

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(32, 32, 32)
                .addComponent(jLabel2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(txtSelid, javax.swing.GroupLayout.PREFERRED_SIZE, 137, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(41, 41, 41)
                .addComponent(jLabel3)
                .addGap(18, 18, 18)
                .addComponent(txtProname, javax.swing.GroupLayout.PREFERRED_SIZE, 137, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(44, 44, 44)
                .addComponent(jLabel4)
                .addGap(18, 18, 18)
                .addComponent(txtSelcount, javax.swing.GroupLayout.PREFERRED_SIZE, 157, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(16, Short.MAX_VALUE))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, jPanel1Layout.createSequentialGroup()
                .addContainerGap(30, Short.MAX_VALUE)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel2)
                    .addComponent(jLabel3)
                    .addComponent(jLabel4)
                    .addComponent(txtSelid, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtProname, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(txtSelcount, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addGap(21, 21, 21))
        );

        jLabel5.setText("退货数量");

        btnSrt.setText("确认退货");
        btnSrt.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnSrtActionPerformed(evt);
            }
        });

        btnCancel.setText("取消");
        btnCancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCancelActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addComponent(dateStart, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jLabel1)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(dateEnd, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(txtCondition, javax.swing.GroupLayout.PREFERRED_SIZE, 205, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(18, 18, 18)
                .addComponent(btnQuery)
                .addContainerGap())
            .addComponent(jScrollPane1, javax.swing.GroupLayout.Alignment.TRAILING)
            .addComponent(jPanel1, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addGroup(layout.createSequentialGroup()
                .addGap(156, 156, 156)
                .addComponent(jLabel5)
                .addGap(18, 18, 18)
                .addComponent(txtReturnAmount, javax.swing.GroupLayout.PREFERRED_SIZE, 197, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(41, 41, 41)
                .addComponent(btnSrt)
                .addGap(39, 39, 39)
                .addComponent(btnCancel)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(18, 18, 18)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel1)
                    .addComponent(txtCondition, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnQuery)
                    .addComponent(dateEnd, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(dateStart, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 271, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(25, 25, 25)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel5)
                    .addComponent(txtReturnAmount, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(btnSrt)
                    .addComponent(btnCancel))
                .addContainerGap(35, Short.MAX_VALUE))
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnQueryActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnQueryActionPerformed
        //按条件查询采购单
        //1获取条件
        String start = this.dateStart.getText();
        String end = this.dateEnd.getText();
        String conditions = this.txtCondition.getText().trim();
        //调用业务
        List<ViewSell> list = sbiz.findByCondition(start, end, conditions);
        //显示在表格中
        showOnTable(list);
    }//GEN-LAST:event_btnQueryActionPerformed

    private void btnCancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCancelActionPerformed
        // TODO add your handling code here:
        //清空文本框
        this.txtSelid.setText("");
        this.txtProname.setText("");
        this.txtSelcount.setText("");
        this.txtReturnAmount.setText("");
        selectrow = -1;
    }//GEN-LAST:event_btnCancelActionPerformed

    private void tblSellMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_tblSellMouseClicked
        selectrow = this.tblSell.getSelectedRow();//selectrow为类属性
        Integer selid = (Integer) this.tblSell.getValueAt(selectrow, 0);
        String proname = (String) this.tblSell.getValueAt(selectrow, 1);
        Integer sellAmount = (Integer) this.tblSell.getValueAt(selectrow, 4);
        //显示在文本框
        this.txtSelid.setText(selid.toString());
        this.txtProname.setText(proname);
        this.txtSelcount.setText(sellAmount.toString());
    }//GEN-LAST:event_tblSellMouseClicked

    private void btnSrtActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnSrtActionPerformed
        // TODO add your handling code here:
        if (selectrow == -1) {
            JOptionPane.showMessageDialog(this, "请选择要退货的采购单信息");
            return;
        }
        //获取退货信息
        Integer selid = Integer.parseInt(this.txtSelid.getText());
        Integer selcount = Integer.parseInt(this.txtSelcount.getText());
        Product pro = pbiz.findBySubquery(selid);
        Customer cus = cusbiz.findBySubquery(selid);
        int proid = pro.getProid();
        int cusid = cus.getCusid();
        BigDecimal srtprice = new BigDecimal(this.tblSell.getValueAt(selectrow, 5).toString());
        //获取退货数量
        String sreturnAmount = this.txtReturnAmount.getText();
        //数据验证
        String regex = "[1-9][0-9]*";
        if (sreturnAmount.matches(regex) == false) {
            JOptionPane.showMessageDialog(this, "请填写整数");
            return;
        }
        // 转换退货数量
        Integer srtcount = Integer.parseInt(sreturnAmount);
        // 判断是否超过采购数量
        if (srtcount > selcount) {
            JOptionPane.showMessageDialog(this, "退货数量大于销售数量");
            return;
        }
        // 获取退货总金额
        BigDecimal srttotal = new BigDecimal(srtprice.multiply(new BigDecimal(srtcount)).toString());
        // 调用业务
        java.sql.Date srtdate = new java.sql.Date(new java.util.Date().getTime());

        boolean result = sbiz.sellsReturn(selid,proid,cusid,srtcount,srtprice,srttotal,srtdate);
        if (result == true) {
            JOptionPane.showMessageDialog(this, "退货成功");
            btnQueryActionPerformed(evt);
        } else {
            JOptionPane.showMessageDialog(this, "退货失败");
        }
        //清空文本框
        this.txtSelid.setText("");
        this.txtProname.setText("");
        this.txtSelcount.setText("");
        this.txtReturnAmount.setText("");
        selectrow = -1;


    }//GEN-LAST:event_btnSrtActionPerformed
    
    private void showOnTable(List<ViewSell> list) {
        //1 表格模型
        DefaultTableModel dtm = (DefaultTableModel) this.tblSell.getModel();
        //2清空表格
        while (dtm.getRowCount() > 0) {
            dtm.removeRow(0);
        }
        //3 添加数据
        for (ViewSell sel : list) {
            Vector vt = new Vector();
            vt.add(sel.getSelid());
            vt.add(sel.getProname());
            vt.add(sel.getType());
            vt.add(sel.getCusname());
            vt.add(sel.getSelcount());
            vt.add(sel.getSelprice());
            vt.add(sel.getSeldate());
            dtm.addRow(vt);

        }
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnCancel;
    private javax.swing.JButton btnQuery;
    private javax.swing.JButton btnSrt;
    private com.ouc.cpss.util.DateChooserJButton dateEnd;
    private com.ouc.cpss.util.DateChooserJButton dateStart;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JPanel jPanel1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JTable tblSell;
    private javax.swing.JTextField txtCondition;
    private javax.swing.JTextField txtProname;
    private javax.swing.JTextField txtReturnAmount;
    private javax.swing.JTextField txtSelcount;
    private javax.swing.JTextField txtSelid;
    // End of variables declaration//GEN-END:variables

}
